<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatchForge - AI Job Matching Platform</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .nav-tab {
            padding: 10px 24px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-tab:hover { background: rgba(255,255,255,0.15); }
        .nav-tab.active {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
            border-color: transparent;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { margin-bottom: 20px; font-size: 1.3rem; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
        input[type="text"], input[type="email"], input[type="password"], input[type="file"], select, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
        }
        input[type="checkbox"] { width: auto; margin-right: 8px; }
        select option { background: #1a1a2e; }
        textarea { min-height: 100px; resize: vertical; }
        .btn {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: #fff;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,212,255,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); box-shadow: none; }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-row .btn { flex: 1; }
        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .score-high { background: linear-gradient(135deg, #00c853, #00e676); }
        .score-medium { background: linear-gradient(135deg, #ffc107, #ffca28); color: #000; }
        .score-low { background: linear-gradient(135deg, #ff5252, #ff1744); }
        .result-section { margin-top: 20px; }
        .result-section h3 { margin-bottom: 10px; font-size: 1rem; color: #00d4ff; }
        .issue {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid;
        }
        .issue.error { border-color: #ff5252; }
        .issue.warning { border-color: #ffc107; }
        .issue.info { border-color: #00d4ff; }
        .issue-severity { font-size: 0.8rem; text-transform: uppercase; opacity: 0.7; }
        .issue-message { margin-top: 4px; }
        .issue-suggestion { font-size: 0.85rem; color: #888; margin-top: 4px; }
        .meta-info { display: flex; gap: 20px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .meta-item { text-align: center; }
        .meta-label { font-size: 0.8rem; color: #888; }
        .meta-value { font-size: 1.1rem; font-weight: 600; }
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 40px; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-form { max-width: 400px; margin: 0 auto; }
        .error-msg { background: rgba(255,82,82,0.2); padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .success-msg { background: rgba(0,200,83,0.2); padding: 12px; border-radius: 8px; margin-bottom: 20px; }

        /* Job Cards */
        .job-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, border-color 0.2s;
        }
        .job-card:hover {
            transform: translateX(5px);
            border-color: rgba(0,212,255,0.3);
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .job-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }
        .job-match {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .job-company {
            color: #00d4ff;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }
        .job-meta {
            display: flex;
            gap: 15px;
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .job-meta span { display: flex; align-items: center; gap: 5px; }
        .job-skills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .skill-tag {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .job-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .skill-fit-panel {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .skill-fit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .skill-fit-score {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .skill-fit-score.high { color: #00e676; }
        .skill-fit-score.medium { color: #ffc107; }
        .skill-fit-score.low { color: #ff5252; }
        .skill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .skill-have {
            background: rgba(0,200,83,0.2);
            color: #00e676;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .skill-missing {
            background: rgba(255,82,82,0.2);
            color: #ff5252;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .skill-section-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .remote-badge {
            background: rgba(0,200,83,0.2);
            color: #00e676;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .search-row {
            display: flex;
            gap: 10px;
        }
        .search-row input { flex: 1; }
        .search-row .btn { width: auto; }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-row label {
            display: flex;
            align-items: center;
            margin: 0;
            color: #aaa;
            font-size: 0.9rem;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .results-count { color: #888; }

        /* Job Source Selector */
        .source-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .source-selector label {
            margin: 0;
            color: #aaa;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .source-selector select {
            width: auto;
            min-width: 200px;
        }

        /* Coaching Styles */
        .coach-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .coach-grid { grid-template-columns: 1fr; }
        }
        .session-card {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .session-coach {
            font-weight: 600;
            color: #00d4ff;
        }
        .session-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .session-status.scheduled { background: rgba(0,200,83,0.2); color: #00e676; }
        .session-status.completed { background: rgba(136,136,136,0.2); color: #888; }
        .session-status.cancelled { background: rgba(255,82,82,0.2); color: #ff5252; }
        .session-time {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }
        .slot-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 0;
        }
        .slot-item {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .slot-item:hover {
            background: rgba(0,212,255,0.1);
            border-color: rgba(0,212,255,0.3);
        }
        .slot-item.selected {
            background: rgba(0,212,255,0.2);
            border-color: #00d4ff;
        }
        .slot-date { font-weight: 600; color: #fff; }
        .slot-time { font-size: 0.85rem; color: #aaa; }
        .slot-coach { font-size: 0.8rem; color: #00d4ff; margin-top: 4px; }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        /* Chat Modal */
        .chat-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .chat-container {
            width: 90%;
            max-width: 600px;
            height: 80vh;
            background: #1a1a2e;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title { font-weight: 600; }
        .chat-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .chat-status.connected { background: rgba(0,200,83,0.2); color: #00e676; }
        .chat-status.disconnected { background: rgba(255,82,82,0.2); color: #ff5252; }
        .chat-status.connecting { background: rgba(255,193,7,0.2); color: #ffc107; }
        .chat-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 5px;
        }
        .chat-close:hover { color: #fff; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        .chat-message.user {
            align-self: flex-end;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
        }
        .chat-message.coach {
            align-self: flex-start;
            background: rgba(255,255,255,0.1);
        }
        .chat-message.system {
            align-self: center;
            background: rgba(255,193,7,0.2);
            color: #ffc107;
            font-size: 0.85rem;
        }
        .message-sender {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 4px;
        }
        .message-time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            margin-top: 4px;
            text-align: right;
        }
        .typing-indicator {
            align-self: flex-start;
            color: #888;
            font-size: 0.85rem;
            font-style: italic;
            padding: 10px;
        }
        .chat-topics {
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .topic-chip {
            background: rgba(123,44,191,0.2);
            border: 1px solid rgba(123,44,191,0.4);
            color: #c084fc;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .topic-chip:hover {
            background: rgba(123,44,191,0.3);
            border-color: rgba(123,44,191,0.6);
        }
        .ai-suggestion {
            align-self: flex-start;
            max-width: 85%;
            background: linear-gradient(135deg, rgba(123,44,191,0.2), rgba(0,212,255,0.2));
            border: 1px solid rgba(123,44,191,0.3);
            border-radius: 12px;
            padding: 12px 15px;
        }
        .ai-suggestion-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #c084fc;
            margin-bottom: 8px;
        }
        .ai-suggestion-content {
            color: #e0e0e0;
            line-height: 1.5;
        }
        .ai-suggestion-footer {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .ai-suggestion-footer button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #aaa;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .ai-suggestion-footer button:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        .ai-suggestion-footer button.use-btn {
            background: rgba(0,212,255,0.2);
            border-color: rgba(0,212,255,0.4);
            color: #00d4ff;
        }
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 10px;
        }
        .chat-input-area input {
            flex: 1;
        }
        .chat-input-area .btn {
            width: auto;
            padding: 12px 20px;
        }
        .btn-ai {
            background: linear-gradient(90deg, #7b2cbf, #c084fc);
        }
        .btn-ai:hover {
            box-shadow: 0 4px 20px rgba(123,44,191,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MatchForge</h1>
        <p class="subtitle">AI-Powered Job Matching Platform</p>

        <!-- Login Section -->
        <div id="login-section" class="card login-form">
            <h2>Login or Register</h2>
            <div id="login-error" class="error-msg hidden"></div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" value="demo@matchforge.com">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" value="DemoPass123">
            </div>
            <button class="btn" onclick="login()">Login / Register</button>
        </div>

        <!-- Main App (hidden until logged in) -->
        <div id="main-app" class="hidden">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab" onclick="showTab('profile')">My Profile</div>
                <div class="nav-tab active" onclick="showTab('ats')">ATS Checker</div>
                <div class="nav-tab" onclick="showTab('jobs')">Find Jobs</div>
                <div class="nav-tab" onclick="showTab('coaching')">Coaching</div>
            </div>

            <!-- Profile Tab -->
            <div id="tab-profile" class="hidden">
                <div class="card">
                    <h2>Your Job Matching Profile</h2>
                    <p style="color: #888; margin-bottom: 20px;">Complete your profile to get better job matches. The more you fill in, the more accurate your match scores will be.</p>

                    <div class="meta-info" style="margin-bottom: 30px;">
                        <div class="meta-item">
                            <div class="meta-label">Profile Strength</div>
                            <div class="meta-value" id="profile-strength">0%</div>
                        </div>
                    </div>

                    <!-- Auto-fill from Resume -->
                    <div style="background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h3 style="margin-bottom: 10px; font-size: 1rem; color: #00d4ff;">Auto-fill from Resume</h3>
                        <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">Upload your resume and we'll extract your skills, experience, and more automatically.</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="profile-resume-file" accept=".pdf,.docx" style="flex: 1;">
                            <button class="btn btn-small" onclick="parseResumeForProfile()">Extract & Fill</button>
                        </div>
                        <div id="parse-status" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
                    </div>

                    <div class="form-group">
                        <label>Your Skills (comma-separated)</label>
                        <input type="text" id="profile-skills" placeholder="Python, AWS, Docker, Kubernetes, SQL, etc.">
                        <small style="color: #666; font-size: 0.8rem;">Enter technical and soft skills relevant to your target roles</small>
                    </div>

                    <div class="form-group">
                        <label>Years of Experience</label>
                        <select id="profile-experience">
                            <option value="">Select...</option>
                            <option value="0">Entry Level (0-1 years)</option>
                            <option value="2">Junior (2-3 years)</option>
                            <option value="4">Mid-Level (4-6 years)</option>
                            <option value="7">Senior (7-10 years)</option>
                            <option value="11">Staff/Principal (11-15 years)</option>
                            <option value="16">Executive (16+ years)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Current Job Title</label>
                        <input type="text" id="profile-current-title" placeholder="Software Engineer, Product Manager, etc.">
                    </div>

                    <div class="form-group">
                        <label>Target Job Titles (comma-separated)</label>
                        <input type="text" id="profile-target-titles" placeholder="Senior Software Engineer, Tech Lead, etc.">
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Minimum Salary ($)</label>
                            <input type="number" id="profile-salary-min" placeholder="80000">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Maximum Salary ($)</label>
                            <input type="number" id="profile-salary-max" placeholder="150000">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preferred Locations (comma-separated)</label>
                        <input type="text" id="profile-locations" placeholder="San Francisco, New York, Austin, Remote">
                    </div>

                    <div class="form-group">
                        <label>Remote Preference</label>
                        <select id="profile-remote">
                            <option value="any">Any (No Preference)</option>
                            <option value="remote">Remote Only</option>
                            <option value="hybrid">Hybrid</option>
                            <option value="onsite">On-site Only</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Certifications (comma-separated)</label>
                        <input type="text" id="profile-certifications" placeholder="AWS Solutions Architect, PMP, CISSP, etc.">
                    </div>

                    <div class="btn-row">
                        <button class="btn" onclick="saveProfile()">Save Profile</button>
                        <button class="btn btn-secondary" onclick="showTab('jobs')">Find Matching Jobs</button>
                    </div>

                    <div id="profile-save-msg" class="success-msg hidden" style="margin-top: 20px;">Profile saved successfully!</div>
                </div>
            </div>

            <!-- ATS Checker Tab -->
            <div id="tab-ats">
                <div id="upload-section" class="card">
                    <h2>Check Your Resume</h2>
                    <div class="form-group">
                        <label>Resume File (PDF or DOCX)</label>
                        <input type="file" id="resume-file" accept=".pdf,.docx">
                    </div>
                    <div class="form-group">
                        <label>Target ATS System</label>
                        <select id="target-ats">
                            <option value="icims">iCIMS (10.7% market share - Legacy)</option>
                            <option value="greenhouse">Greenhouse (6-7% - Modern Cloud)</option>
                            <option value="workday">Workday (7-8% - HCM Integrated)</option>
                            <option value="taleo">Oracle Taleo (8-9% - Legacy)</option>
                            <option value="lever">Lever (4-5% - Modern Cloud)</option>
                            <option value="bullhorn">Bullhorn (2-3% - Staffing)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Job Description (optional - for keyword matching)</label>
                        <textarea id="job-description" placeholder="Paste the job description here to get keyword suggestions..."></textarea>
                    </div>
                    <button class="btn" onclick="checkResume()">Check ATS Compatibility</button>
                </div>

                <!-- Loading -->
                <div id="loading-section" class="card hidden">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Analyzing your resume...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="card hidden">
                    <h2>ATS Compatibility Results</h2>

                    <div class="meta-info">
                        <div class="meta-item">
                            <div class="meta-label">Target ATS</div>
                            <div class="meta-value" id="result-ats">-</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Parser Group</div>
                            <div class="meta-value" id="result-group">-</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Market Coverage</div>
                            <div class="meta-value" id="result-coverage">-</div>
                        </div>
                    </div>

                    <div id="score-display"></div>

                    <div id="issues-section" class="result-section"></div>
                    <div id="suggestions-section" class="result-section"></div>

                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="resetAtsForm()">Check Another</button>
                        <button class="btn" onclick="showTab('jobs')">Find Matching Jobs</button>
                    </div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div id="tab-jobs" class="hidden">
                <div class="card">
                    <h2>Search Jobs</h2>
                    <div class="source-selector">
                        <label>Job Source:</label>
                        <select id="job-sources">
                            <option value="themuse">The Muse - Real Jobs (Recommended)</option>
                            <option value="jobspy">Indeed/ZipRecruiter/Glassdoor (May be slow)</option>
                            <option value="usajobs">USAJobs (Government - Requires API key)</option>
                            <option value="adzuna">Adzuna (Global - Requires API key)</option>
                            <option value="demo">Demo Jobs (50 fake samples)</option>
                            <option value="all">All Sources</option>
                        </select>
                    </div>
                    <div class="search-row">
                        <input type="text" id="job-keywords" placeholder="Keywords (e.g., Python, DevOps, Security)">
                        <button class="btn" onclick="searchJobs()">Search</button>
                    </div>
                    <div class="filter-row">
                        <label>
                            <input type="checkbox" id="remote-only"> Remote Only
                        </label>
                        <label>
                            Location:
                            <input type="text" id="job-location" placeholder="Any" style="width: 150px; margin-left: 8px;">
                        </label>
                    </div>
                </div>

                <!-- Job Loading -->
                <div id="jobs-loading" class="card hidden">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Finding matching jobs...</p>
                    </div>
                </div>

                <!-- Job Results -->
                <div id="jobs-results" class="hidden">
                    <div class="results-header">
                        <h2>Matching Jobs</h2>
                        <span class="results-count" id="jobs-count">0 jobs found</span>
                    </div>
                    <div id="jobs-list"></div>

                    <!-- Skill Gap Analysis Section -->
                    <div class="card" style="margin-top: 20px; border: 1px solid rgba(123,44,191,0.3);">
                        <h3 style="color: #7b2cbf; margin-bottom: 15px;">Skill Gap Analysis</h3>
                        <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                            See which skills you're missing for these jobs and get learning recommendations.
                        </p>
                        <button class="btn btn-secondary" onclick="analyzeSkillGaps()">Analyze My Skill Gaps</button>
                        <div id="skill-gap-loading" class="loading hidden" style="margin-top: 15px;">
                            <div class="spinner"></div>
                            <p>Analyzing skill gaps...</p>
                        </div>
                        <div id="skill-gap-results" class="hidden" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>

            <!-- Coaching Tab -->
            <div id="tab-coaching" class="hidden">
                <!-- AI Quick Help Card -->
                <div class="card" style="margin-bottom: 20px; border: 1px solid rgba(123,44,191,0.3);">
                    <h2 style="color: #c084fc;">AI Career Coach</h2>
                    <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                        Get instant career advice powered by AI. For more in-depth guidance, book a session with a human coach below.
                    </p>
                    <div id="ai-quick-topics" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="ai-quick-input" placeholder="Ask a career question..." style="flex: 1;">
                        <button class="btn btn-ai" onclick="askQuickAI()">Ask AI</button>
                    </div>
                    <div id="ai-quick-loading" class="loading hidden" style="margin-top: 15px;">
                        <div class="spinner"></div>
                        <p>AI is thinking...</p>
                    </div>
                    <div id="ai-quick-response" class="hidden" style="margin-top: 15px;"></div>
                </div>

                <div class="coach-grid">
                    <!-- Book Session Card -->
                    <div class="card">
                        <h2>Book a Session</h2>
                        <div class="form-group">
                            <label>Session Type</label>
                            <select id="session-type">
                                <option value="chat">Chat Session (30 min)</option>
                                <option value="video" disabled>Video Call (Coming Soon)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Available Slot</label>
                            <div id="slots-loading" class="loading">
                                <div class="spinner"></div>
                                <p>Loading available slots...</p>
                            </div>
                            <div id="slots-container" class="slot-picker hidden"></div>
                        </div>
                        <button id="book-btn" class="btn" onclick="bookSession()" disabled>Select a Slot to Book</button>
                    </div>

                    <!-- My Sessions Card -->
                    <div class="card">
                        <h2>My Sessions</h2>
                        <div id="sessions-loading" class="loading">
                            <div class="spinner"></div>
                            <p>Loading sessions...</p>
                        </div>
                        <div id="sessions-list" class="hidden"></div>
                        <div id="sessions-empty" class="empty-state hidden">
                            <p>No sessions booked yet.</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">Book your first coaching session to get personalized career advice!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="chat-modal hidden">
            <div class="chat-container">
                <div class="chat-header">
                    <div>
                        <div class="chat-title" id="chat-title">Coach Chat</div>
                        <div class="chat-status connecting" id="chat-status">Connecting...</div>
                    </div>
                    <button class="chat-close" onclick="closeChat()">&times;</button>
                </div>
                <div id="chat-topics" class="chat-topics hidden"></div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="typing-indicator hidden" id="typing-indicator">Coach is typing...</div>
                <div id="ai-loading" class="loading hidden" style="padding: 10px;">
                    <div class="spinner" style="width: 24px; height: 24px;"></div>
                    <p style="font-size: 0.85rem;">AI is thinking...</p>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message or ask AI for help..." onkeypress="handleChatKeypress(event)">
                    <button class="btn btn-ai btn-small" onclick="askAI()" title="Get AI coaching suggestion">AI Help</button>
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api/v1';
        const WS_BASE = 'ws://localhost:8001/api/v1';
        let authToken = null;
        let currentUserId = null;
        let selectedSlot = null;
        let chatSocket = null;
        let currentSessionId = null;

        // Force correct initial state on page load
        (function initPage() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('chat-modal').classList.add('hidden');
            if (chatSocket) { chatSocket.close(); chatSocket = null; }
        })();

        function showTab(tab) {
            // Update nav
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab[onclick="showTab('${tab}')"]`).classList.add('active');

            // Show/hide tabs
            document.getElementById('tab-profile').classList.toggle('hidden', tab !== 'profile');
            document.getElementById('tab-ats').classList.toggle('hidden', tab !== 'ats');
            document.getElementById('tab-jobs').classList.toggle('hidden', tab !== 'jobs');
            document.getElementById('tab-coaching').classList.toggle('hidden', tab !== 'coaching');

            // Load data when tabs are shown
            if (tab === 'profile') {
                loadProfile();
            }
            if (tab === 'coaching') {
                loadAvailableSlots();
                loadMySessions();
                loadQuickAITopics();
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            // Try to register first
            try {
                await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, full_name: 'Demo User' })
                });
            } catch (e) {}

            // Then login
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (res.ok) {
                    const data = await res.json();
                    authToken = data.access_token;
                    currentUserId = data.user_id || email.replace('@', '_').replace('.', '_');
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                } else {
                    const err = await res.json();
                    errorDiv.textContent = err.detail || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (e) {
                errorDiv.textContent = 'Connection error. Is the server running on port 8001?';
                errorDiv.classList.remove('hidden');
            }
        }

        async function checkResume() {
            const fileInput = document.getElementById('resume-file');
            const targetAts = document.getElementById('target-ats').value;
            const jobDesc = document.getElementById('job-description').value;

            if (!fileInput.files[0]) {
                alert('Please select a resume file');
                return;
            }

            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loading-section').classList.remove('hidden');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('target_ats', targetAts);
            if (jobDesc) formData.append('job_description', jobDesc);

            try {
                const res = await fetch(`${API_BASE}/jobs/resume-check`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                document.getElementById('loading-section').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    showAtsResults(data);
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Check failed'));
                    document.getElementById('upload-section').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('upload-section').classList.remove('hidden');
                alert('Connection error: ' + e.message);
            }
        }

        function showAtsResults(data) {
            document.getElementById('results-section').classList.remove('hidden');

            // Meta info
            document.getElementById('result-ats').textContent = (data.target_ats || 'General').toUpperCase();
            document.getElementById('result-group').textContent = data.parser_group || 'N/A';
            document.getElementById('result-coverage').textContent = data.market_coverage || 'N/A';

            // Score circle
            const score = data.overall_score;
            let scoreClass = 'score-low';
            if (score >= 80) scoreClass = 'score-high';
            else if (score >= 60) scoreClass = 'score-medium';

            document.getElementById('score-display').innerHTML = `
                <div class="score-circle ${scoreClass}">${score}</div>
                <p style="text-align: center; color: #888;">out of 100</p>
            `;

            // Issues
            const issuesHtml = data.issues.map(issue => `
                <div class="issue ${issue.severity}">
                    <div class="issue-severity">${issue.severity}</div>
                    <div class="issue-message">${issue.message}</div>
                    <div class="issue-suggestion">${issue.suggestion}</div>
                </div>
            `).join('');

            document.getElementById('issues-section').innerHTML = `
                <h3>Issues Found (${data.issues.length})</h3>
                ${issuesHtml || '<p style="color:#888">No issues found!</p>'}
            `;

            // Suggestions
            if (data.suggestions && data.suggestions.length > 0) {
                document.getElementById('suggestions-section').innerHTML = `
                    <h3>Keyword Suggestions</h3>
                    ${data.suggestions.map(s => `<div class="issue info"><div class="issue-message">${s}</div></div>`).join('')}
                `;
            } else {
                document.getElementById('suggestions-section').innerHTML = '';
            }
        }

        function resetAtsForm() {
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('resume-file').value = '';
            document.getElementById('job-description').value = '';
        }

        async function searchJobs() {
            const keywords = document.getElementById('job-keywords').value || 'Python';
            const remoteOnly = document.getElementById('remote-only').checked;
            const location = document.getElementById('job-location').value;
            const sourceSelect = document.getElementById('job-sources').value;

            // Determine which sources to use
            let sources;
            if (sourceSelect === 'all') {
                sources = ['themuse', 'usajobs', 'adzuna', 'jobspy'];
            } else {
                sources = [sourceSelect];
            }

            document.getElementById('jobs-loading').classList.remove('hidden');
            document.getElementById('jobs-results').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/jobs/search`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords,
                        remote_only: remoteOnly,
                        location: location || null,
                        sources: sources,
                        page_size: 10
                    })
                });

                document.getElementById('jobs-loading').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    showJobResults(data);
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Search failed'));
                }
            } catch (e) {
                document.getElementById('jobs-loading').classList.add('hidden');
                alert('Connection error: ' + e.message);
            }
        }

        function showJobResults(data) {
            document.getElementById('jobs-results').classList.remove('hidden');
            document.getElementById('jobs-count').textContent = `${data.total} jobs found`;

            const jobsHtml = data.jobs.map(match => {
                const job = match.job;
                const score = match.match_scores?.total_score || 0;
                const skills = job.required_skills?.slice(0, 4) || [];
                const salary = job.salary_min && job.salary_max
                    ? `$${(job.salary_min/1000).toFixed(0)}k - $${(job.salary_max/1000).toFixed(0)}k`
                    : '';

                // Store job data for skill fit check
                const jobDataAttr = encodeURIComponent(JSON.stringify({
                    id: job.id,
                    title: job.title,
                    required_skills: job.required_skills || []
                }));

                return `
                    <div class="job-card" id="job-card-${job.id}">
                        <div class="job-header">
                            <div class="job-title">${job.title}</div>
                            <div class="job-match">${score}% Match</div>
                        </div>
                        <div class="job-company">${job.company || 'Company'}</div>
                        <div class="job-meta">
                            <span>${job.location || 'Location not specified'}</span>
                            ${job.is_remote ? '<span class="remote-badge">Remote</span>' : ''}
                            ${salary ? `<span>${salary}</span>` : ''}
                        </div>
                        <div class="job-skills">
                            ${skills.map(s => `<span class="skill-tag">${s}</span>`).join('')}
                        </div>
                        <div class="job-actions">
                            <button class="btn btn-secondary btn-small" onclick="checkSkillFit('${job.id}', '${jobDataAttr}')">Check My Fit</button>
                            <button class="btn btn-secondary btn-small" onclick="saveJob('${job.id}')">Save</button>
                            <button class="btn btn-small" onclick="applyJob('${job.id}', '${job.source_url || ''}')">Apply Now</button>
                        </div>
                        <div id="skill-fit-${job.id}" class="skill-fit-panel hidden"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('jobs-list').innerHTML = jobsHtml || '<p style="color:#888; text-align:center; padding:40px;">No jobs found. Try different keywords.</p>';
        }

        async function saveJob(jobId) {
            try {
                await fetch(`${API_BASE}/jobs/${jobId}/save`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                alert('Job saved!');
            } catch (e) {
                alert('Could not save job');
            }
        }

        function applyJob(jobId, sourceUrl) {
            if (sourceUrl) {
                window.open(sourceUrl, '_blank');
            } else {
                alert('Application link not available for demo jobs. In production, this would redirect to the job posting.');
            }
        }

        async function quickParseResume(jobId, jobDataEncoded) {
            const fileInput = document.getElementById(`quick-resume-${jobId}`);
            const statusEl = document.getElementById(`quick-parse-status-${jobId}`);

            if (!fileInput.files[0]) {
                statusEl.innerHTML = '<span style="color: #ff5252;">Please select a resume file first.</span>';
                return;
            }

            statusEl.innerHTML = '<span style="color: #ffc107;">Parsing resume...</span>';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('auto_update_profile', 'true');

            try {
                const res = await fetch(`${API_BASE}/jobs/parse-resume`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    const extracted = data.extracted;

                    if (extracted.skills && extracted.skills.length > 0) {
                        // Save skills to profile form
                        document.getElementById('profile-skills').value = extracted.skills.join(', ');

                        // Also save other extracted data
                        if (extracted.current_title) {
                            document.getElementById('profile-current-title').value = extracted.current_title;
                        }
                        if (extracted.years_experience) {
                            const select = document.getElementById('profile-experience');
                            const years = extracted.years_experience;
                            if (years <= 1) select.value = '0';
                            else if (years <= 3) select.value = '2';
                            else if (years <= 6) select.value = '4';
                            else if (years <= 10) select.value = '7';
                            else if (years <= 15) select.value = '11';
                            else select.value = '16';
                        }

                        statusEl.innerHTML = `<span style="color: #00e676;">Found ${extracted.skills.length} skills! Checking fit...</span>`;

                        // Re-run skill fit check after short delay
                        setTimeout(() => {
                            checkSkillFit(jobId, jobDataEncoded);
                        }, 500);
                    } else {
                        statusEl.innerHTML = '<span style="color: #ff5252;">No skills found in resume. Try a different file.</span>';
                    }
                } else {
                    const err = await res.json();
                    statusEl.innerHTML = `<span style="color: #ff5252;">Error: ${err.detail || 'Parse failed'}</span>`;
                }
            } catch (e) {
                statusEl.innerHTML = `<span style="color: #ff5252;">Connection error: ${e.message}</span>`;
            }
        }

        function checkSkillFit(jobId, jobDataEncoded) {
            const panel = document.getElementById(`skill-fit-${jobId}`);

            // Toggle if already visible
            if (!panel.classList.contains('hidden')) {
                panel.classList.add('hidden');
                return;
            }

            const jobData = JSON.parse(decodeURIComponent(jobDataEncoded));
            const jobSkills = (jobData.required_skills || []).map(s => s.toLowerCase());

            // Get user skills from profile form
            const userSkillsRaw = document.getElementById('profile-skills').value;
            const userSkills = userSkillsRaw
                .split(',')
                .map(s => s.trim().toLowerCase())
                .filter(s => s);

            if (userSkills.length === 0) {
                panel.innerHTML = `
                    <div style="text-align: center; padding: 15px;">
                        <p style="color: #ffc107; margin-bottom: 15px;">Upload your resume to check skill fit</p>
                        <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="quick-resume-${jobId}" accept=".pdf,.docx" style="max-width: 200px;">
                            <button class="btn btn-small" onclick="quickParseResume('${jobId}', '${jobDataEncoded}')">Analyze Skills</button>
                        </div>
                        <div id="quick-parse-status-${jobId}" style="margin-top: 10px; font-size: 0.85rem;"></div>
                    </div>
                `;
                panel.classList.remove('hidden');
                return;
            }

            if (jobSkills.length === 0) {
                panel.innerHTML = `
                    <div style="text-align: center; padding: 10px; color: #888;">
                        <p>This job listing doesn't specify required skills.</p>
                    </div>
                `;
                panel.classList.remove('hidden');
                return;
            }

            // Compare skills (with fuzzy matching)
            const skillsYouHave = [];
            const skillsYouMissing = [];

            jobSkills.forEach(jobSkill => {
                const hasSkill = userSkills.some(userSkill =>
                    skillsMatchFuzzy(jobSkill, userSkill)
                );
                if (hasSkill) {
                    skillsYouHave.push(jobSkill);
                } else {
                    skillsYouMissing.push(jobSkill);
                }
            });

            const fitPercent = jobSkills.length > 0
                ? Math.round((skillsYouHave.length / jobSkills.length) * 100)
                : 0;

            const scoreClass = fitPercent >= 70 ? 'high' : fitPercent >= 40 ? 'medium' : 'low';
            const fitMessage = fitPercent >= 70 ? 'Strong fit!' :
                               fitPercent >= 40 ? 'Partial fit - consider upskilling' :
                               'Skill gap - may need more experience';

            panel.innerHTML = `
                <div class="skill-fit-header">
                    <div>
                        <span class="skill-fit-score ${scoreClass}">${fitPercent}% Skill Match</span>
                        <span style="color: #888; font-size: 0.85rem; margin-left: 10px;">${fitMessage}</span>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('skill-fit-${jobId}').classList.add('hidden')">Close</button>
                </div>

                ${skillsYouHave.length > 0 ? `
                    <div class="skill-section-label">Skills You Have (${skillsYouHave.length}/${jobSkills.length})</div>
                    <div class="skill-list">
                        ${skillsYouHave.map(s => `<span class="skill-have"> ${capitalizeSkill(s)}</span>`).join('')}
                    </div>
                ` : ''}

                ${skillsYouMissing.length > 0 ? `
                    <div class="skill-section-label">Skills to Develop (${skillsYouMissing.length})</div>
                    <div class="skill-list">
                        ${skillsYouMissing.map(s => `<span class="skill-missing"> ${capitalizeSkill(s)}</span>`).join('')}
                    </div>
                ` : ''}

                ${skillsYouMissing.length > 0 ? `
                    <div style="margin-top: 15px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <p style="color: #888; font-size: 0.85rem;">
                            Missing ${skillsYouMissing.length} skill${skillsYouMissing.length > 1 ? 's' : ''} for this role.
                            <a href="#" onclick="showTab('jobs'); setTimeout(analyzeSkillGaps, 100); return false;" style="color: #00d4ff;">
                                Get learning recommendations 
                            </a>
                        </p>
                    </div>
                ` : `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,200,83,0.1); border-radius: 6px;">
                        <p style="color: #00e676; font-size: 0.9rem;">
                            You have all the listed skills! Consider applying.
                        </p>
                    </div>
                `}
            `;

            panel.classList.remove('hidden');
        }

        function skillsMatchFuzzy(skill1, skill2) {
            const s1 = skill1.toLowerCase().trim();
            const s2 = skill2.toLowerCase().trim();

            // Exact match
            if (s1 === s2) return true;

            // One contains the other
            if (s1.includes(s2) || s2.includes(s1)) return true;

            // Common variations
            const variations = {
                'javascript': ['js', 'node.js', 'nodejs', 'node'],
                'typescript': ['ts'],
                'python': ['py'],
                'kubernetes': ['k8s'],
                'postgresql': ['postgres', 'psql', 'pgsql'],
                'amazon web services': ['aws'],
                'google cloud': ['gcp', 'google cloud platform'],
                'microsoft azure': ['azure'],
                'react': ['reactjs', 'react.js'],
                'vue': ['vuejs', 'vue.js'],
                'angular': ['angularjs'],
                'machine learning': ['ml'],
                'artificial intelligence': ['ai'],
                'continuous integration': ['ci', 'ci/cd'],
                'continuous deployment': ['cd', 'ci/cd'],
            };

            for (const [canonical, aliases] of Object.entries(variations)) {
                const allForms = [canonical, ...aliases];
                if (allForms.includes(s1) && allForms.includes(s2)) return true;
                if (allForms.some(f => f === s1) && allForms.some(f => f === s2)) return true;
            }

            return false;
        }

        function capitalizeSkill(skill) {
            // Special cases for acronyms
            const acronyms = ['aws', 'gcp', 'sql', 'css', 'html', 'api', 'ci/cd', 'ai', 'ml', 'ui', 'ux'];
            if (acronyms.includes(skill.toLowerCase())) {
                return skill.toUpperCase();
            }
            return skill.split(' ').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        async function analyzeSkillGaps() {
            const keywords = document.getElementById('job-keywords').value || 'software engineer';
            const location = document.getElementById('job-location').value;

            document.getElementById('skill-gap-loading').classList.remove('hidden');
            document.getElementById('skill-gap-results').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/jobs/skill-gaps`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        location: location || null,
                        top_n: 5
                    })
                });

                document.getElementById('skill-gap-loading').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    showSkillGapResults(data);
                } else {
                    const err = await res.json();
                    document.getElementById('skill-gap-results').innerHTML =
                        `<p style="color: #ff5252;">Error: ${err.detail || 'Analysis failed'}</p>`;
                    document.getElementById('skill-gap-results').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('skill-gap-loading').classList.add('hidden');
                document.getElementById('skill-gap-results').innerHTML =
                    `<p style="color: #ff5252;">Connection error: ${e.message}</p>`;
                document.getElementById('skill-gap-results').classList.remove('hidden');
            }
        }

        function showSkillGapResults(data) {
            const container = document.getElementById('skill-gap-results');

            if (!data.skill_gaps || data.skill_gaps.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(0,200,83,0.1); padding: 15px; border-radius: 8px;">
                        <strong style="color: #00e676;">Great news!</strong>
                        <p style="color: #888; margin-top: 5px;">Your skills align well with these jobs. Consider deepening your expertise in your existing skills.</p>
                    </div>
                `;
                container.classList.remove('hidden');
                return;
            }

            let html = `
                <div style="margin-bottom: 15px;">
                    <p style="color: #888; font-size: 0.9rem;">
                        Analyzed <strong>${data.jobs_analyzed}</strong> jobs.
                        You have <strong>${data.user_skills_count}</strong> skills.
                        Potential improvement: <strong style="color: #00e676;">${data.potential_score_improvement}</strong>
                    </p>
                </div>
                <h4 style="margin-bottom: 10px; color: #fff;">Top Skill Gaps</h4>
            `;

            data.skill_gaps.forEach((gap, i) => {
                const priority = gap.demand_score > 50 ? 'high' : 'medium';
                const priorityColor = priority === 'high' ? '#ff5252' : '#ffc107';

                html += `
                    <div class="issue" style="border-color: ${priorityColor}; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #fff;">${gap.skill}</strong>
                            <span style="font-size: 0.8rem; color: ${priorityColor};">
                                ${gap.demand_score}% demand  ${gap.jobs_requiring} jobs
                            </span>
                        </div>
                    </div>
                `;
            });

            if (data.recommendations && data.recommendations.length > 0) {
                html += `<h4 style="margin: 20px 0 10px; color: #fff;">Learning Recommendations</h4>`;

                data.recommendations.forEach(rec => {
                    html += `
                        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #00d4ff;">${rec.skill}</strong>
                                <span style="font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;
                                    background: ${rec.priority === 'high' ? 'rgba(255,82,82,0.2)' : 'rgba(255,193,7,0.2)'};
                                    color: ${rec.priority === 'high' ? '#ff5252' : '#ffc107'};">
                                    ${rec.priority} priority
                                </span>
                            </div>
                            <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 5px;">
                                <strong>Resource:</strong> ${rec.resource}
                            </p>
                            <p style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">
                                <strong>Time:</strong> ${rec.time_estimate}
                                ${rec.certification ? `  <strong>Cert:</strong> ${rec.certification}` : ''}
                            </p>
                            <p style="color: #666; font-size: 0.8rem; font-style: italic;">
                                ${rec.resume_tip}
                            </p>
                        </div>
                    `;
                });
            }

            if (data.analysis_summary) {
                html += `
                    <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <p style="color: #00d4ff; font-size: 0.9rem;">${data.analysis_summary}</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        // ==================== COACHING FUNCTIONS ====================

        async function loadAvailableSlots() {
            document.getElementById('slots-loading').classList.remove('hidden');
            document.getElementById('slots-container').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/coaching/slots?days_ahead=14`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                document.getElementById('slots-loading').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    renderSlots(data.slots);
                } else {
                    document.getElementById('slots-container').innerHTML = '<p style="color:#888">Could not load slots</p>';
                    document.getElementById('slots-container').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('slots-loading').classList.add('hidden');
                document.getElementById('slots-container').innerHTML = '<p style="color:#ff5252">Connection error</p>';
                document.getElementById('slots-container').classList.remove('hidden');
            }
        }

        function renderSlots(slots) {
            const container = document.getElementById('slots-container');

            if (!slots || slots.length === 0) {
                container.innerHTML = '<p style="color:#888">No available slots. Check back later!</p>';
                container.classList.remove('hidden');
                return;
            }

            // Group slots by date for better display
            const slotsByDate = {};
            slots.slice(0, 30).forEach(slot => {
                const date = new Date(slot.start_time);
                const dateKey = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                if (!slotsByDate[dateKey]) slotsByDate[dateKey] = [];
                slotsByDate[dateKey].push(slot);
            });

            let html = '';
            for (const [date, dateSlots] of Object.entries(slotsByDate)) {
                dateSlots.forEach(slot => {
                    const time = new Date(slot.start_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    html += `
                        <div class="slot-item" onclick="selectSlot(this, '${slot.coach_id}', '${slot.start_time}', '${slot.coach_name}')">
                            <div class="slot-date">${date}</div>
                            <div class="slot-time">${time}</div>
                            <div class="slot-coach">${slot.coach_name}</div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        function selectSlot(element, coachId, startTime, coachName) {
            // Remove selection from all
            document.querySelectorAll('.slot-item').forEach(el => el.classList.remove('selected'));
            // Select this one
            element.classList.add('selected');

            selectedSlot = { coachId, startTime, coachName };

            const btn = document.getElementById('book-btn');
            btn.disabled = false;
            btn.textContent = `Book with ${coachName}`;
        }

        async function bookSession() {
            if (!selectedSlot) {
                alert('Please select a slot first');
                return;
            }

            const sessionType = document.getElementById('session-type').value;
            const btn = document.getElementById('book-btn');
            btn.disabled = true;
            btn.textContent = 'Booking...';

            try {
                const res = await fetch(`${API_BASE}/coaching/book`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        coach_id: selectedSlot.coachId,
                        scheduled_start: selectedSlot.startTime,
                        session_type: sessionType
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`Session booked with ${selectedSlot.coachName}!`);
                    selectedSlot = null;
                    btn.textContent = 'Select a Slot to Book';
                    loadAvailableSlots();
                    loadMySessions();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Could not book session'));
                    btn.disabled = false;
                    btn.textContent = `Book with ${selectedSlot.coachName}`;
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
                btn.disabled = false;
                btn.textContent = `Book with ${selectedSlot.coachName}`;
            }
        }

        async function loadMySessions() {
            document.getElementById('sessions-loading').classList.remove('hidden');
            document.getElementById('sessions-list').classList.add('hidden');
            document.getElementById('sessions-empty').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/coaching/sessions`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                document.getElementById('sessions-loading').classList.add('hidden');

                if (res.ok) {
                    const sessions = await res.json();
                    renderSessions(sessions);
                } else {
                    document.getElementById('sessions-empty').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('sessions-loading').classList.add('hidden');
                document.getElementById('sessions-list').innerHTML = '<p style="color:#ff5252">Could not load sessions</p>';
                document.getElementById('sessions-list').classList.remove('hidden');
            }
        }

        function renderSessions(sessions) {
            const container = document.getElementById('sessions-list');

            if (!sessions || sessions.length === 0) {
                document.getElementById('sessions-empty').classList.remove('hidden');
                return;
            }

            let html = '';
            sessions.forEach(session => {
                const startDate = new Date(session.scheduled_start);
                const dateStr = startDate.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
                const timeStr = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                const canJoin = session.status === 'scheduled';
                const canCancel = session.status === 'scheduled';
                const hoursUntil = (startDate - new Date()) / (1000 * 60 * 60);

                // Generate session ID for chat
                const sessionId = session.join_url ? session.join_url.replace('/chat/', '') :
                    `${session.user_id}_${session.coach_id}_${Math.floor(startDate.getTime() / 1000)}`;

                html += `
                    <div class="session-card">
                        <div class="session-header">
                            <span class="session-coach">Coach: ${session.coach_id}</span>
                            <span class="session-status ${session.status}">${session.status}</span>
                        </div>
                        <div class="session-time">${dateStr} at ${timeStr} (${session.session_type})</div>
                        <div class="session-actions">
                            ${canJoin ? `<button class="btn btn-small" onclick="openChat('${sessionId}', '${session.coach_id}')">Join Chat</button>` : ''}
                            ${canCancel ? `<button class="btn btn-secondary btn-small" onclick="cancelSession('${session.id}')">${hoursUntil >= 24 ? 'Cancel (Refund)' : 'Cancel'}</button>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        async function cancelSession(sessionId) {
            if (!confirm('Are you sure you want to cancel this session?')) return;

            try {
                const res = await fetch(`${API_BASE}/coaching/sessions/${sessionId}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(data.message);
                    loadMySessions();
                    loadAvailableSlots();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.detail || 'Could not cancel session'));
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            }
        }

        // ==================== AI QUICK HELP FUNCTIONS ====================

        async function loadQuickAITopics() {
            try {
                const res = await fetch(`${API_BASE}/coaching/topics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const container = document.getElementById('ai-quick-topics');
                    if (data.topics && data.topics.length > 0) {
                        container.innerHTML = data.topics.slice(0, 6).map(t =>
                            `<span class="topic-chip" onclick="setQuickAITopic('${escapeHtml(t.prompt)}')">${t.topic}</span>`
                        ).join('');
                    }
                }
            } catch (e) {
                console.log('Could not load quick topics:', e);
            }
        }

        function setQuickAITopic(prompt) {
            document.getElementById('ai-quick-input').value = prompt;
            askQuickAI();
        }

        async function askQuickAI() {
            const input = document.getElementById('ai-quick-input');
            const question = input.value.trim();

            if (!question) {
                alert('Please enter a question');
                return;
            }

            document.getElementById('ai-quick-loading').classList.remove('hidden');
            document.getElementById('ai-quick-response').classList.add('hidden');

            try {
                const res = await fetch(`${API_BASE}/coaching/ai-assist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        conversation_history: []
                    })
                });

                document.getElementById('ai-quick-loading').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    showQuickAIResponse(question, data);
                } else {
                    const err = await res.json();
                    document.getElementById('ai-quick-response').innerHTML =
                        `<p style="color: #ff5252;">Error: ${err.detail || 'Could not get response'}</p>`;
                    document.getElementById('ai-quick-response').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('ai-quick-loading').classList.add('hidden');
                document.getElementById('ai-quick-response').innerHTML =
                    `<p style="color: #ff5252;">Connection error: ${e.message}</p>`;
                document.getElementById('ai-quick-response').classList.remove('hidden');
            }
        }

        function showQuickAIResponse(question, data) {
            const container = document.getElementById('ai-quick-response');
            const confidenceText = data.confidence === 'high' ? 'High confidence' :
                                   data.confidence === 'needs_review' ? 'Coach-verified recommended' : 'General guidance';
            const confidenceColor = data.confidence === 'high' ? '#00e676' :
                                    data.confidence === 'needs_review' ? '#ffc107' : '#888';

            container.innerHTML = `
                <div class="ai-suggestion" style="max-width: 100%;">
                    <div class="ai-suggestion-header">
                        <span style="color: ${confidenceColor};">&#9679;</span>
                        AI Career Coach  ${confidenceText}
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong style="color: #888; font-size: 0.85rem;">Your question:</strong>
                        <p style="color: #fff; margin-top: 4px;">${escapeHtml(question)}</p>
                    </div>
                    <div class="ai-suggestion-content">${escapeHtml(data.draft_response)}</div>
                    ${data.suggested_followup ? `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,212,255,0.1); border-radius: 8px;">
                            <strong style="color: #00d4ff; font-size: 0.85rem;">Want to dig deeper?</strong>
                            <p style="color: #aaa; font-size: 0.9rem; margin-top: 4px;">${escapeHtml(data.suggested_followup)}</p>
                            <button class="btn btn-secondary btn-small" style="margin-top: 10px;"
                                onclick="document.getElementById('ai-quick-input').value='${escapeHtml(data.suggested_followup)}'; askQuickAI();">
                                Ask This
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <p style="color: #888; font-size: 0.85rem; margin-bottom: 10px;">
                        For personalized guidance, book a session with a human coach
                    </p>
                </div>
            `;
            container.classList.remove('hidden');
        }

        // ==================== CHAT FUNCTIONS ====================

        let chatConversationHistory = [];
        let currentAISuggestion = null;

        function openChat(sessionId, coachId) {
            currentSessionId = sessionId;
            chatConversationHistory = [];
            document.getElementById('chat-modal').classList.remove('hidden');
            document.getElementById('chat-title').textContent = `Chat with ${coachId}`;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';

            connectWebSocket(sessionId);
            loadCoachingTopics();
        }

        async function loadCoachingTopics() {
            try {
                const res = await fetch(`${API_BASE}/coaching/topics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    renderTopicChips(data.topics);
                }
            } catch (e) {
                console.log('Could not load topics:', e);
            }
        }

        function renderTopicChips(topics) {
            const container = document.getElementById('chat-topics');
            if (!topics || topics.length === 0) {
                container.classList.add('hidden');
                return;
            }

            const html = topics.map(t =>
                `<span class="topic-chip" onclick="selectTopic('${escapeHtml(t.prompt)}')">${t.topic}</span>`
            ).join('');

            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        function selectTopic(prompt) {
            document.getElementById('chat-input').value = prompt;
            document.getElementById('chat-topics').classList.add('hidden');
            askAI();
        }

        async function askAI() {
            const input = document.getElementById('chat-input');
            const question = input.value.trim();

            if (!question) {
                alert('Please enter a question to ask the AI');
                return;
            }

            document.getElementById('ai-loading').classList.remove('hidden');

            try {
                const res = await fetch(`${API_BASE}/coaching/ai-assist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        conversation_history: chatConversationHistory
                    })
                });

                document.getElementById('ai-loading').classList.add('hidden');

                if (res.ok) {
                    const data = await res.json();
                    currentAISuggestion = data;
                    showAISuggestion(question, data);

                    // Hide topics after first question
                    document.getElementById('chat-topics').classList.add('hidden');
                } else {
                    const err = await res.json();
                    alert('AI Error: ' + (err.detail || 'Could not get suggestion'));
                }
            } catch (e) {
                document.getElementById('ai-loading').classList.add('hidden');
                alert('Connection error: ' + e.message);
            }
        }

        function showAISuggestion(question, data) {
            const messagesEl = document.getElementById('chat-messages');

            // First show the user's question
            const userMsg = {
                type: 'message',
                sender_type: 'user',
                content: question,
                timestamp: new Date().toISOString()
            };
            addChatMessage(userMsg);
            chatConversationHistory.push(userMsg);

            // Then show AI suggestion
            const confidenceText = data.confidence === 'high' ? 'High confidence' :
                                   data.confidence === 'needs_review' ? 'Needs coach review' : 'Template response';
            const confidenceColor = data.confidence === 'high' ? '#00e676' :
                                    data.confidence === 'needs_review' ? '#ffc107' : '#888';

            const suggestionHtml = `
                <div class="ai-suggestion" id="current-ai-suggestion">
                    <div class="ai-suggestion-header">
                        <span style="color: ${confidenceColor};">&#9679;</span>
                        AI Career Coach  ${confidenceText}
                    </div>
                    <div class="ai-suggestion-content">${escapeHtml(data.draft_response)}</div>
                    ${data.suggested_followup ? `
                        <div style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                            <strong>Suggested follow-up:</strong> ${escapeHtml(data.suggested_followup)}
                        </div>
                    ` : ''}
                    <div class="ai-suggestion-footer">
                        <button onclick="askFollowup()">Ask More</button>
                        <button class="use-btn" onclick="useAISuggestion()">Send as Message</button>
                    </div>
                </div>
            `;

            messagesEl.insertAdjacentHTML('beforeend', suggestionHtml);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // Clear input
            document.getElementById('chat-input').value = '';
        }

        function useAISuggestion() {
            if (!currentAISuggestion) return;

            // Remove the suggestion card
            const suggestionEl = document.getElementById('current-ai-suggestion');
            if (suggestionEl) suggestionEl.remove();

            // Send as a coach message
            const coachMsg = {
                type: 'message',
                sender_type: 'coach',
                content: currentAISuggestion.draft_response,
                timestamp: new Date().toISOString()
            };
            addChatMessage(coachMsg);
            chatConversationHistory.push(coachMsg);

            // Also send via websocket if connected
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    type: 'message',
                    sender_id: 'ai_coach',
                    sender_type: 'coach',
                    content: currentAISuggestion.draft_response
                }));
            }

            currentAISuggestion = null;
        }

        function askFollowup() {
            if (currentAISuggestion && currentAISuggestion.suggested_followup) {
                document.getElementById('chat-input').value = currentAISuggestion.suggested_followup;
            }
            document.getElementById('chat-input').focus();
        }

        function closeChat() {
            document.getElementById('chat-modal').classList.add('hidden');
            if (chatSocket) {
                chatSocket.close();
                chatSocket = null;
            }
            currentSessionId = null;
        }

        function connectWebSocket(sessionId) {
            const statusEl = document.getElementById('chat-status');
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'chat-status connecting';

            chatSocket = new WebSocket(`${WS_BASE}/coaching/chat/${sessionId}`);

            chatSocket.onopen = () => {
                statusEl.textContent = 'Connected';
                statusEl.className = 'chat-status connected';
            };

            chatSocket.onclose = () => {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'chat-status disconnected';
            };

            chatSocket.onerror = (error) => {
                statusEl.textContent = 'Connection Error';
                statusEl.className = 'chat-status disconnected';
                console.error('WebSocket error:', error);
            };

            chatSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleChatMessage(data);
            };
        }

        function handleChatMessage(data) {
            const messagesEl = document.getElementById('chat-messages');
            const typingEl = document.getElementById('typing-indicator');

            switch (data.type) {
                case 'connected':
                    addSystemMessage('Connected to chat session');
                    break;

                case 'history':
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            if (msg.type === 'message') {
                                addChatMessage(msg);
                            }
                        });
                    }
                    break;

                case 'message':
                    addChatMessage(data);
                    // Track in history for AI context
                    chatConversationHistory.push({
                        sender_type: data.sender_type,
                        content: data.content,
                        timestamp: data.timestamp
                    });
                    break;

                case 'typing':
                    if (data.sender_type === 'coach' && data.is_typing) {
                        typingEl.classList.remove('hidden');
                    } else {
                        typingEl.classList.add('hidden');
                    }
                    break;

                case 'system':
                    addSystemMessage(data.content);
                    break;
            }
        }

        function addChatMessage(msg) {
            const messagesEl = document.getElementById('chat-messages');
            const isUser = msg.sender_type === 'user';

            const time = msg.timestamp ?
                new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) :
                '';

            const messageHtml = `
                <div class="chat-message ${isUser ? 'user' : 'coach'}">
                    <div class="message-sender">${isUser ? 'You' : 'Coach'}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            messagesEl.insertAdjacentHTML('beforeend', messageHtml);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function addSystemMessage(content) {
            const messagesEl = document.getElementById('chat-messages');
            messagesEl.insertAdjacentHTML('beforeend', `
                <div class="chat-message system">${escapeHtml(content)}</div>
            `);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content) return;

            // Add to conversation history for AI context
            const msg = {
                type: 'message',
                sender_id: currentUserId,
                sender_type: 'user',
                content: content,
                timestamp: new Date().toISOString()
            };

            // If websocket is connected, send via websocket
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify(msg));
            } else {
                // Otherwise just show locally (for AI-only chat)
                addChatMessage(msg);
            }

            chatConversationHistory.push(msg);
            input.value = '';
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            } else {
                // Send typing indicator
                if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({
                        type: 'typing',
                        sender_id: currentUserId,
                        sender_type: 'user',
                        is_typing: true
                    }));
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== PROFILE FUNCTIONS ====================

        async function loadProfile() {
            try {
                const res = await fetch(`${API_BASE}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const profile = await res.json();
                    populateProfileForm(profile);
                }
            } catch (e) {
                console.error('Could not load profile:', e);
            }
        }

        function populateProfileForm(profile) {
            document.getElementById('profile-skills').value = (profile.skills || []).join(', ');
            document.getElementById('profile-experience').value = profile.years_experience || '';
            document.getElementById('profile-current-title').value = profile.current_title || '';
            document.getElementById('profile-target-titles').value = (profile.target_titles || []).join(', ');
            document.getElementById('profile-salary-min').value = profile.salary_min || '';
            document.getElementById('profile-salary-max').value = profile.salary_max || '';
            document.getElementById('profile-locations').value = (profile.preferred_locations || []).join(', ');
            document.getElementById('profile-remote').value = profile.remote_preference || 'any';
            document.getElementById('profile-certifications').value = (profile.certifications || []).join(', ');
            document.getElementById('profile-strength').textContent = (profile.profile_strength || 0) + '%';
        }

        async function parseResumeForProfile() {
            const fileInput = document.getElementById('profile-resume-file');
            const statusEl = document.getElementById('parse-status');

            if (!fileInput.files[0]) {
                statusEl.textContent = 'Please select a resume file first.';
                statusEl.style.color = '#ff5252';
                return;
            }

            statusEl.textContent = 'Parsing resume...';
            statusEl.style.color = '#ffc107';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('auto_update_profile', 'true');

            try {
                const res = await fetch(`${API_BASE}/jobs/parse-resume`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    const extracted = data.extracted;

                    // Populate form fields
                    if (extracted.skills && extracted.skills.length > 0) {
                        document.getElementById('profile-skills').value = extracted.skills.join(', ');
                    }
                    if (extracted.years_experience) {
                        // Find closest option
                        const select = document.getElementById('profile-experience');
                        const years = extracted.years_experience;
                        if (years <= 1) select.value = '0';
                        else if (years <= 3) select.value = '2';
                        else if (years <= 6) select.value = '4';
                        else if (years <= 10) select.value = '7';
                        else if (years <= 15) select.value = '11';
                        else select.value = '16';
                    }
                    if (extracted.current_title) {
                        document.getElementById('profile-current-title').value = extracted.current_title;
                    }
                    if (extracted.target_titles && extracted.target_titles.length > 0) {
                        document.getElementById('profile-target-titles').value = extracted.target_titles.join(', ');
                    }
                    if (extracted.certifications && extracted.certifications.length > 0) {
                        document.getElementById('profile-certifications').value = extracted.certifications.join(', ');
                    }
                    if (extracted.locations && extracted.locations.length > 0) {
                        document.getElementById('profile-locations').value = extracted.locations.join(', ');
                    }
                    if (extracted.salary_estimate) {
                        if (extracted.salary_estimate.min) {
                            document.getElementById('profile-salary-min').value = extracted.salary_estimate.min;
                        }
                        if (extracted.salary_estimate.max) {
                            document.getElementById('profile-salary-max').value = extracted.salary_estimate.max;
                        }
                    }

                    // Update profile strength if available
                    if (extracted.new_profile_strength) {
                        document.getElementById('profile-strength').textContent = extracted.new_profile_strength + '%';
                    }

                    const modelUsed = data.metadata?.model || 'keyword extraction';
                    const savedMsg = extracted.profile_updated ? ' Profile auto-saved!' : ' Review and save!';
                    statusEl.textContent = `Extracted ${extracted.skills?.length || 0} skills using ${modelUsed}.${savedMsg}`;
                    statusEl.style.color = '#00e676';
                } else {
                    const err = await res.json();
                    statusEl.textContent = 'Error: ' + (err.detail || 'Parse failed');
                    statusEl.style.color = '#ff5252';
                }
            } catch (e) {
                statusEl.textContent = 'Connection error: ' + e.message;
                statusEl.style.color = '#ff5252';
            }
        }

        async function saveProfile() {
            const skills = document.getElementById('profile-skills').value
                .split(',').map(s => s.trim()).filter(s => s);
            const experience = document.getElementById('profile-experience').value;
            const currentTitle = document.getElementById('profile-current-title').value.trim();
            const targetTitles = document.getElementById('profile-target-titles').value
                .split(',').map(s => s.trim()).filter(s => s);
            const salaryMin = parseInt(document.getElementById('profile-salary-min').value) || null;
            const salaryMax = parseInt(document.getElementById('profile-salary-max').value) || null;
            const locations = document.getElementById('profile-locations').value
                .split(',').map(s => s.trim()).filter(s => s);
            const remote = document.getElementById('profile-remote').value;
            const certifications = document.getElementById('profile-certifications').value
                .split(',').map(s => s.trim()).filter(s => s);

            const profileData = {
                skills: skills,
                years_experience: experience ? parseInt(experience) : null,
                current_title: currentTitle || null,
                target_titles: targetTitles,
                salary_min: salaryMin,
                salary_max: salaryMax,
                preferred_locations: locations,
                remote_preference: remote,
                certifications: certifications
            };

            try {
                const res = await fetch(`${API_BASE}/auth/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });

                if (res.ok) {
                    const updated = await res.json();
                    document.getElementById('profile-strength').textContent = (updated.profile_strength || 0) + '%';
                    const msgEl = document.getElementById('profile-save-msg');
                    msgEl.classList.remove('hidden');
                    setTimeout(() => msgEl.classList.add('hidden'), 3000);
                } else {
                    const err = await res.json();
                    alert('Error saving profile: ' + (err.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error: ' + e.message);
            }
        }
    </script>
</body>
</html>
